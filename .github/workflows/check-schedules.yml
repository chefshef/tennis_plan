name: Check Scheduled Bookings

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check and trigger due bookings
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Current time in milliseconds
          NOW_MS=$(($(date +%s) * 1000))
          echo "Current time: $(date)"
          echo "Current epoch ms: $NOW_MS"

          # Read scheduled bookings
          if [ ! -f scheduled-bookings.json ]; then
            echo "No scheduled-bookings.json found"
            exit 0
          fi

          BOOKINGS=$(cat scheduled-bookings.json)
          echo "Bookings file contents:"
          echo "$BOOKINGS" | jq .

          # Process each booking
          TRIGGERED_IDS=""
          echo "$BOOKINGS" | jq -c '.bookings[]' 2>/dev/null | while read -r booking; do
            ID=$(echo "$booking" | jq -r '.id')
            TARGET_DATE=$(echo "$booking" | jq -r '.targetDate')
            TARGET_TIME=$(echo "$booking" | jq -r '.targetTime')
            TRIGGER_AT=$(echo "$booking" | jq -r '.triggerAt')

            echo ""
            echo "Checking booking: $ID"
            echo "  Target: $TARGET_DATE at $TARGET_TIME"
            echo "  Trigger at: $TRIGGER_AT ($(date -d @$((TRIGGER_AT / 1000)) 2>/dev/null || date -r $((TRIGGER_AT / 1000))))"
            echo "  Now: $NOW_MS"

            # Trigger if current time >= trigger time
            if [ "$NOW_MS" -ge "$TRIGGER_AT" ]; then
              echo "  ✅ Time to trigger!"

              # Trigger the booking workflow
              gh workflow run book-court.yml \
                --ref main \
                -f target_date="$TARGET_DATE" \
                -f target_time="$TARGET_TIME"

              echo "$ID" >> /tmp/triggered_ids.txt
            else
              DIFF=$(( (TRIGGER_AT - NOW_MS) / 1000 / 60 ))
              echo "  ⏳ Not yet - $DIFF minutes until trigger"
            fi
          done

          # Remove triggered bookings from file
          if [ -f /tmp/triggered_ids.txt ]; then
            echo ""
            echo "Removing triggered bookings from file..."

            # Read triggered IDs
            while read -r triggered_id; do
              BOOKINGS=$(echo "$BOOKINGS" | jq --arg id "$triggered_id" '.bookings = [.bookings[] | select(.id != $id)]')
            done < /tmp/triggered_ids.txt

            # Update file
            echo "$BOOKINGS" > scheduled-bookings.json

            # Commit changes
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add scheduled-bookings.json
            git commit -m "Remove triggered bookings" || true
            git push || true
          fi
