name: Check Scheduled Bookings

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check and trigger due bookings
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: America/New_York
        run: |
          # Fetch open issues with 'scheduled' label (exclude already triggered)
          ISSUES=$(gh issue list --label "scheduled" --json number,title,body,labels --limit 100)

          echo "Found scheduled bookings:"
          echo "$ISSUES" | jq -r '.[] | "Issue #\(.number): \(.title)"'

          # Current timestamp (in EST due to TZ env var)
          NOW=$(date +%s)
          echo "Current time (EST): $(date '+%Y-%m-%d %H:%M %Z')"

          # Process each issue
          echo "$ISSUES" | jq -c '.[]' | while read -r issue; do
            NUMBER=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            BODY=$(echo "$issue" | jq -r '.body')
            LABELS=$(echo "$issue" | jq -r '.labels[].name' | tr '\n' ' ')

            # Skip if already triggered
            if echo "$LABELS" | grep -q "triggered"; then
              echo "Issue #$NUMBER: Already triggered, skipping"
              continue
            fi

            # Parse target date and time from body
            TARGET_DATE=$(echo "$BODY" | grep "Date:" | cut -d' ' -f2)
            TARGET_TIME=$(echo "$BODY" | grep "Time:" | cut -d' ' -f2)

            if [ -z "$TARGET_DATE" ] || [ -z "$TARGET_TIME" ]; then
              echo "Issue #$NUMBER: Missing date or time, skipping"
              continue
            fi

            echo "Issue #$NUMBER: Target is $TARGET_DATE at $TARGET_TIME"

            # Booking window opens exactly 7 days before, at the SAME TIME
            # e.g., 2/18 7:00 PM booking opens at 2/11 7:00 PM
            TARGET_DATETIME="${TARGET_DATE}T${TARGET_TIME}:00"

            # Calculate booking window time (7 days before at same time)
            BOOKING_WINDOW_TS=$(date -d "$TARGET_DATETIME - 7 days" +%s 2>/dev/null || \
              date -j -v-7d -f "%Y-%m-%dT%H:%M:%S" "$TARGET_DATETIME" +%s 2>/dev/null)

            # Trigger when booking window is within 5 minutes (cron runs every 5 min)
            FIVE_MINS=300
            TRIGGER_TS=$((BOOKING_WINDOW_TS - FIVE_MINS))

            # Format times for logging
            TRIGGER_DATE=$(date -d "@$TRIGGER_TS" "+%Y-%m-%d %H:%M" 2>/dev/null || date -r "$TRIGGER_TS" "+%Y-%m-%d %H:%M")
            BOOKING_DATE=$(date -d "@$BOOKING_WINDOW_TS" "+%Y-%m-%d %H:%M" 2>/dev/null || date -r "$BOOKING_WINDOW_TS" "+%Y-%m-%d %H:%M")

            echo "  - Trigger time (5min early): $TRIGGER_DATE"
            echo "  - Booking window opens: $BOOKING_DATE"
            echo "  - Now: $(date '+%Y-%m-%d %H:%M')"

            # Check if we're in the trigger window (trigger time has passed, but booking time hasn't)
            if [ "$NOW" -ge "$TRIGGER_TS" ] && [ "$NOW" -lt "$BOOKING_WINDOW_TS" ]; then
              echo "Issue #$NUMBER: ‚úÖ Booking window opens soon! Triggering job now."

              # Trigger the booking workflow (using workflow_dispatch for better runner priority)
              gh workflow run book-court.yml \
                --ref main \
                -f target_date="$TARGET_DATE" \
                -f target_time="$TARGET_TIME"

              # Mark as triggered
              gh issue edit "$NUMBER" --add-label "triggered"
              gh issue comment "$NUMBER" --body "üöÄ Booking job triggered at $(date). Running now - will retry if slot not available yet."

            elif [ "$NOW" -ge "$BOOKING_WINDOW_TS" ]; then
              echo "Issue #$NUMBER: ‚ö†Ô∏è Missed trigger window! Triggering immediately as fallback."
              gh workflow run book-court.yml \
                --ref main \
                -f target_date="$TARGET_DATE" \
                -f target_time="$TARGET_TIME"
              gh issue edit "$NUMBER" --add-label "triggered" --add-label "late"
              gh issue comment "$NUMBER" --body "‚ö†Ô∏è Missed optimal trigger window. Running immediately at $(date)."
            else
              echo "Issue #$NUMBER: ‚è≥ Not yet time. Will trigger at $TRIGGER_DATE"
            fi
          done
